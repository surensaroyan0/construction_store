<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{{ STATIC_URL }}/css/header.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}/css/profile.css">
    <title>BuildSupply Co</title>
</head>
<body id="body">
    <header>
        <div class="size">
            <div class="around">
                <div class="header_box logo">
                    <h1><a href="/api/home/">BuildSupply Co</a></h1>
                </div>
                <div class="header_box menu">
                    <nav>
                        <ul>
                            <li><a href="/api/about/">About Us</a></li>
                            <li><a href="/api/cart/">Cart</a></li>
                            <li><a href="/api/orders/">Orders</a></li>
                            <li><a href="/api/purchases/">Purchases</a></li>
                            <li>Profile
                                <ul>
                                    <li><a href="/api/user/profile/{{ store_user.id }}/">Settings</a></li>
                                    <li><a href="/api/user/logout/">Log out</a></li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <section class="form_parent">
        <form action="/api/user/profile/{{ store_user.id }}/" method="post" enctype="multipart/form-data">
        {% csrf_token %}
            <div class="size">
                <div class="profile-pic">
                    <label class="-label" for="file">
                        <span class="change_image">Change Image</span>
                    </label>
                    <input type="file" name="profile_picture" onchange="loadFile(event)" id="file">

                    <img src="{% if store_user.profile_picture %} {{ store_user.profile_picture }}
                        {% else %} {{ STATIC_URL }}/img/profile_picture.webp {% endif %}" id="output">
                </div>

                <label for="username">Username:</label>
                <input type="text" id="username" name="username" value="{{ store_user.username }}">

                <label for="firstname">Firstname:</label>
                <input type="text" id="firstname" name="firstname" value="{{ store_user.firstname }}">

                <label for="lastname">Lastname:</label>
                <input type="text" id="lastname" name="lastname" value="{{ store_user.lastname }}">

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" value="{{ store_user.email }}">

                <p class="error_message">{{ error }}</p>
                <label for="phone_number">Phone Number:</label>
                <input type="text" id="phone_number" name="phone_number" value="{{ store_user.phone_number }}">

                <div class="gender">
                    <label>Gender:</label>
                    <div class="male">
                        <input type="radio" name="gender" id="male"
                               {% if store_user.gender == "Male" %}checked{% endif %} value="1">
                        <label for="male">Male</label>
                    </div>
                    <div class="female">
                        <input type="radio" name="gender" id="female"
                               {% if store_user.gender == "Female" %}checked{% endif %} value="2">
                        <label for="female">Female</label>
                    </div>
                </div>

                {% for payment_card in payment_cards %}
                    <div class="added_payment_card" onclick="selectCard(this)">
                        {% if payment_card.is_main %}
                            <h4 class="added_card_main-or-set chosen">Main card</h4>
                            <input type="hidden" id="selected_card_id" value="{{ payment_card.id }}" name="card_id">
                        {% else %}
                            <h4 class="added_card_main-or-set">Set as main</h4>
                            <input type="hidden" id="selected_card_id" value="{{ payment_card.id }}">
                        {% endif %}
                        <p class="added_card_number">{{ payment_card.card_number }} <span>Visa</span></p>
                    </div>
                {% endfor %}

                <p class="payment_card" id="payment_card">+ Add payment card</p>

                <input type="submit" value="Update">
            </div>
        </form>

        <form id="paymentForm" action="/api/payment-card/" method="post" class="payment_block">
        {% csrf_token %}
            <div class="size">
            <script>
                const paymentForm = document.getElementById('paymentForm');
                const body = document.getElementById('body');

                {% if error_message %}
                    paymentForm.classList.toggle('block');
                    body.classList.toggle('background_grey');
                {% endif %}
            </script>
                <p class="error_message">{{ error }}</p>
                <p id="closePaymentForm">X</p>
                <label for="cardNumber">Card Number:</label>
                <input type="text" id="cardNumber" name="card_number" placeholder="Enter card number" maxlength="19" required>

                <label for="cardholderName">Cardholder Name:</label>
                <input type="text" id="cardholderName" name="cardholder_name" placeholder="Enter cardholder name" required>

                <label for="expirationMonth">Expiration Month:</label>
                <input type="text" id="expirationMonth" name="expiration_month" placeholder="MM"
                       maxlength="2" minlength="2" required>
                <label for="expirationYear">Expiration Year:</label>
                <input type="text" id="expirationYear" name="expiration_year" placeholder="YYYY" maxlength="4" required>

                <label for="cvv">CVV:</label>
                <input type="text" id="cvv" name="cvv" placeholder="CVV" maxlength="3" required>

                <input type="submit" value="Submit">
            </div>
        </form>
    </section>


    <script>
        const card = document.getElementById('payment_card');
        const closePayment = document.getElementById('closePaymentForm');
        const cardNumber = document.getElementById('cardNumber');
        const expirationMonthInput = document.getElementById('expirationMonth');

        var loadFile = function (event) {
            var image = document.getElementById("output");
            image.src = URL.createObjectURL(event.target.files[0]);
        };

        card.addEventListener('click', () => {
            paymentForm.classList.toggle('block');
            body.classList.toggle('background_grey');
        });

        closePayment.addEventListener('click', (event) => {
            event.preventDefault();
            paymentForm.classList.remove('block');
            body.classList.remove('background_grey');
        });

        cardNumber.addEventListener('input', function(event) {
            let value = event.target.value;
            value = value.replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            event.target.value = value;
        });

        cardNumber.addEventListener('keydown', function(event) {
            const key = event.key;
            if (key === 'Backspace' || key === 'Delete') {
                const selectionStart = event.target.selectionStart;
                const selectionEnd = event.target.selectionEnd;
                const value = event.target.value;

                if (selectionStart === selectionEnd) {
                    if (key === 'Backspace' && value.charAt(selectionStart -1) === ' ') {
                        event.preventDefault()
                        event.target.setSelectionRange(selectionStart - 1, selectionStart - 1);
                    } else if (key === 'Delete' && value.charAt(selectionStart) === ' ') {
                        event.preventDefault()
                        event.target.setSelectionRange(selectionStart + 1, selectionStart + 1);
                    }
                }
            }
        });

        function selectCard(cardElement) {
            const allCards = document.querySelectorAll('.added_payment_card');

            const addedCardMainOrSet = cardElement.querySelector('.added_card_main-or-set');
            const selectedCardId = cardElement.querySelector('#selected_card_id');

            if (!addedCardMainOrSet.classList.contains('chosen')) {
                allCards.forEach(card => {
                    card.querySelector('.added_card_main-or-set').classList.remove('chosen');
                    card.querySelector('.added_card_main-or-set').textContent = "Set as main";
                    card.querySelector('#selected_card_id').removeAttribute('name');
                });
                addedCardMainOrSet.classList.add('chosen');
                addedCardMainOrSet.textContent = "Main card";
                selectedCardId.setAttribute('name', 'card_id');
            }
        }

        expirationMonthInput.addEventListener('input', function() {
            let value = expirationMonthInput.value.replace(/\D/g, '');
            let intValue = parseInt(value);

            if (intValue < 0) {
                expirationMonthInput.value = '01';
            } else if (intValue > 12) {
                expirationMonthInput.value = '12';
            } else if (intValue > 1 && value <= 9) {
                expirationMonthInput.value = '0' + value;
            } else if (value == '00') {
                expirationMonthInput.value = '';
            }
        });

        expirationMonthInput.addEventListener('blur', function() {
            let value = parseInt(expirationMonthInput.value.replace(/\D/g, ''));

            if (value == 1) {
                expirationMonthInput.value = '0' + value;
            }
        });
    </script>
</body>
</html>
