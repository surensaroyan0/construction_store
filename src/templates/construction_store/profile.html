<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{{ STATIC_URL }}/css/profile.css">
    <title>BuildSupply Co</title>
</head>
<body id="body">
    <header>
        <div class="size">
            <div class="around">
                <div class="header_box logo">
                    <h1><a href="/api/home/">BuildSupply Co</a></h1>
                </div>
                <div class="header_box menu">
                    <nav>
                        <ul>
                            <li><a href="/api/about/">About Us</a></li>
                        {% if store_user %}
                            <li><a href="/api/cart/">Cart</a></li>
                            <li><a href="/api/orders/">Orders</a></li>
                            <li>Profile
                                <ul>
                                    <li><a href="/api/user/profile/{{ store_user.id }}/">Settings</a></li>
                                    <li><a href="/api/user/logout/">Log out</a></li>
                                </ul>
                            </li>
                        {% else %}
                            <li><a href="/api/user/login/">Sign In</a></li>
                        {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </header>

{% if error_message %}
    <p class="error">{{ error_message }}</p>
{% else %}
    <section class="form_parent">
        <form action="/api/user/profile/{{ store_user.id }}/" method="post" enctype="multipart/form-data">
        {% csrf_token %}
            <div class="size">
                <div class="profile-pic">
                    <label class="-label" for="file">
                        <span class="change_image">Change Image</span>
                    </label>
                    <input type="file" name="profile_picture" onchange="loadFile(event)" id="file">
                    {% if store_user.profile_picture %}
                        <img src="{{ store_user.profile_picture }}" id="output">
                    {% else %}
                        <img src="{{ STATIC_URL }}/img/profile_picture.webp" id="output">
                    {% endif %}
                </div>

                <label for="username">Username:</label>
                <input type="text" id="username" name="username" value="{{ store_user.username }}">

                <label for="firstname">Firstname:</label>
                <input type="text" id="firstname" name="firstname" value="{{ store_user.firstname }}">

                <label for="lastname">Lastname:</label>
                <input type="text" id="lastname" name="lastname" value="{{ store_user.lastname }}">

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" value="{{ store_user.email }}">

                <label for="phone_number">Phone Number:</label>
                <input type="text" id="phone_number" name="phone_number" value="{{ store_user.phone_number }}">

                <div class="gender">
                    <label>Gender:</label>
                    <div class="male">
                        <input type="radio" name="gender" id="male"
                               {% if store_user.gender == "Male" %}checked{% endif %} value="1">
                        <label for="male">Male</label>
                    </div>
                    <div class="female">
                        <input type="radio" name="gender" id="female"
                               {% if store_user.gender == "Female" %}checked{% endif %} value="2">
                        <label for="female">Female</label>
                    </div>
                </div>

                <p class="payment_card" id="payment_card">+ Add payment card</p>

                <input type="submit" value="Save Changes">
            </div>
        </form>
        <form id="paymentForm" class="payment_block" action="/api/payment-card/" method="post">
        {% csrf_token %}
            <div class="size">
                <p id="closePaymentForm">X</p>
                {% if expiration %}
                    <p class="expiration">{{ expiration }}</p>
                {% endif %}
                <label for="cardNumber">Card Number:</label>
                <input type="text" id="cardNumber" name="card_number" placeholder="Enter card number" maxlength="19" required>

                <label for="cardholderName">Cardholder Name:</label>
                <input type="text" id="cardholderName" name="cardholder_name" placeholder="Enter cardholder name" required>

                <label for="expirationMonth">Expiration Month:</label>
                <input type="text" id="expirationMonth" name="expiration_month" placeholder="MM" maxlength="2" required>
                <label for="expirationYear">Expiration Year:</label>
                <input type="text" id="expirationYear" name="expiration_year" placeholder="YYYY" maxlength="4" required>

                <label for="cvv">CVV:</label>
                <input type="text" id="cvv" name="cvv" placeholder="CVV" maxlength="3" required>

                <input type="submit" value="Submit">
            </div>
        </form>
    </section>
{% endif %}
    <script>
        const card = document.getElementById('payment_card');
        const paymentForm = document.getElementById('paymentForm');
        const body = document.getElementById('body');
        const closePayment = document.getElementById('closePaymentForm');
        const cardNumber = document.getElementById('cardNumber');

        var loadFile = function (event) {
            var image = document.getElementById("output");
            image.src = URL.createObjectURL(event.target.files[0]);
        };

        card.addEventListener('click', () => {
            paymentForm.classList.toggle('block');
            body.classList.toggle('background_grey');
        });

        closePayment.addEventListener('click', (event) => {
            event.preventDefault();
            paymentForm.classList.remove('block');
            body.classList.remove('background_grey');
        });

        cardNumber.addEventListener('input', function(event) {
            let value = event.target.value.replace(/\s/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            event.target.value = value;
        });

        cardNumber.addEventListener('keydown', function(event) {
            const key = event.key;
            if (key == 'Backspace' || key == 'Delete') {
                const selectionStart = event.target.selectionStart;
                const selectionEnd = event.target.selectionEnd;
                const value = event.target.value;

                if (selectionStart === selectionEnd) {
                    event.preventDefault()
                    event.target.setSelectionRange(selectionStart - 1, selectionStart - 1);
                } else if (key === 'Delete' && value.charAt(selectionStart) === ' ') {
                    event.preventDefault()
                    event.target.setSelectionRange(selectionStart + 1, selectionStart + 1);
                }
            }
        });
    </script>
</body>
</html>
